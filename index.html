<!DOCTYPE html>
<html>
<head>
  <title>Dunkeld Growth</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
   integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
   crossorigin=""/>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
   integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
	crossorigin=""></script>

  <script src="./bower_components/leaflet-layer-overpass/dist/OverPassLayer.js"></script>
  <link rel="stylesheet" href="bower_components/leaflet-layer-overpass/dist/OverPassLayer.css"/>

  <style>
      html, body {
          height: 100%;
          margin: 0;
          padding: 0;
      }

      #map {
          width: 100%;
          height: calc(100% - 60px); /* Adjust the height based on the slider's height */
          background-image: url('images/background.png'); /* Replace with your image path */
          background-size: cover; /* Ensure the image covers the entire area */
          background-position: center center;
          background-repeat: repeat;
          background-size: 10em;
      }

      .leaflet-control-layers-horizontal {
          display: flex;
          overflow-x: auto;
          white-space: nowrap;
          max-width: 300px; /* Adjust this width as needed */
          background: white; /* Ensure it has a background */
          padding: 5px; /* Optional padding */
          border-radius: 5px; /* Optional rounded corners */
          box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); /* Optional shadow */
      }

      .leaflet-control-layers-horizontal input {
          margin-right: 5px;
      }

      .leaflet-control-layers-horizontal label {
          margin-right: 10px; /* Add space between labels */
      }

      .slider-container {
          position: absolute;
          bottom: 0;
          left: 10%;
          width: 80%;
          height: 60px;
          background: rgba(255, 255, 255, 0.2);
          display: flex;
          justify-content: center;
          align-items: center;
      }

      .slider-bar {
          position: relative;
          width: 100%; /* The slider bar width is 80% of the container */
          height: 10px;
          background-color: #ccc;
          border-radius: 5px;
      }

      .slider-handle {
          position: absolute;
          top: 10px; /* Adjust this value to center the handle vertically */
          left: 20%; /* Start at the leftmost part of the slider bar */
          width: 40px;
          height: 40px;
          background-color: #007bff;
          border-radius: 50%;
          cursor: grab;
      }

      #slider-label {
          position: absolute;
          z-index:1000;
          bottom: 80px;
          background: rgba(255, 255, 255, 0.8); /* Optional background color */
          padding: 5px;
          border-radius: 3px;
          box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); /* Optional shadow */
      }

      .leaflet-layer {
        transition: opacity 0.5s ease;
      }

      .layer-fade-out {
          opacity: 0;
      }

      .layer-fade-in {
          opacity: 1;
      }

  </style>
</head>
<body>

<div id="map" class="map map-home"></div>

<div class="slider-container">
  <div class="slider-bar" id="slider"></div>
  <div class="slider-handle" id="slider-handle"></div>
  <div id="slider-label">Layer Name</div>
</div>



<script>
    // Initialize Leaflet

    //POI attribute text
    var attr_overpass = 'POI via <a href="http://www.overpass-api.de/">Overpass API</a>';

    var attr_osm = 'Map data &copy; <a href="http://openstreetmap.org/">OpenStreetMap</a> contributors';
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: [attr_osm, attr_overpass].join(', ')
    });

    // Here we specify our map layers, earliest to latest.
    // The earliest becomes our 'basemap' and is set as the 'layers' in 'modernMap' variable
    // Each of these maps is georeferenced in QGIS and exported, the images and data is held in the 'data' folder

    // var layer_1747_0 = new L.ImageOverlay("data/1747_0.png" ,
    //   [[56.56352338161414, -3.593942911392028], [56.56779636459364, -3.583077326101295]], {
    //   attribution: "Produced by x in 1747, as part of x"
    // });

    // var layer_1823_0 = new L.ImageOverlay("data/1823_0.png" ,
    //   [[56.56414553831824,-3.5911778614642507],[56.56790816284288,-3.5820294644259865]], {
    //   attribution: "Produced by x in 1823, as part of x"
    // });


    // Since these maps are already georeferenced thanks to NLS
    // they take the form of tiles, not image overlays.
    // Other than that the behave the same way

    var tile_1747 = L.tileLayer('data/1747/{z}/{x}/{y}.png', {
        minZoom: 9, maxZoom: 16, tms: false,
        attribution: ["Produced by x in 1747, as part of x", attr_overpass].join(', ')
    });

    var tile_1823 = L.tileLayer('data/1823/{z}/{x}/{y}.png', {
        minZoom: 9, maxZoom: 16, tms: false,
        attribution: ["Produced by x in 1823, as part of x", attr_overpass].join(', ')
    });

    var tile_1864 = L.tileLayer('https://api.maptiler.com/tiles/uk-osgb10k1888/{z}/{x}/{y}.jpg?key=wv0AU1AXH7akvUkNUgLx', {
        maxZoom: 28,
        attribution: ["Perthshire, Sheet LXII, Survey date: 1864, Publication date: 1867, produced by Ordnance Survey", attr_overpass].join(', ')
    });

    var tile_1937_61 = L.tileLayer('https://api.maptiler.com/tiles/uk-osgb25k1937/{z}/{x}/{y}.jpg?key=wv0AU1AXH7akvUkNUgLx', {
        maxZoom: 28,
        attribution: ["NO04, Revised: 1938 - 1955, Published: 1957, produced by Ordnance Survey", attr_overpass].join(', ')
      });

    var modernMap = L.map('map', {
        center: [56.56585, -3.5875],
        //dragging: false, //disable panning
        touchZoom: false, // disable zooming
        zoomControl: false, // hide zoom buttons
        zoom: 16,
        layers: [osm, tile_1747, tile_1823, tile_1864, tile_1937_61] // Add all layers here
    });

    var baseLayers = {
        //
    };

    // In chronological order, list maps here
    var mainOverlayLayers = {
        "1747": tile_1747,
        "1823": tile_1823,
        "1864": tile_1864,
        "1955": tile_1937_61,
        "2024": osm
    };

    // Embedding points data directly
    var pointsData = [
        {
            "name": "Wow look at this photo",
            "description": "This photo show a thing happening at that place",
            "latitude": 56.56561477,
            "longitude": -3.58550088,
            "photo": "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f2/Scanian_War_Collage.jpg/1280px-Scanian_War_Collage.jpg"
        }
    ];

    // Process the points data
    var photoLayer = L.layerGroup();

    pointsData.forEach(point => {
        var pos = new L.LatLng(point.latitude, point.longitude);
        var popup = `<h3>${point.name}</h3><p>${point.description}</p><img src="${point.photo}" alt="${point.name}" style="width: 100%; height: auto;">`;
        var circle = L.circle(pos, 10, {
            color: '#000',
            fillColor: '#000',
            fillOpacity: 0.5
        }).bindPopup(popup);
        photoLayer.addLayer(circle);
    });

    // Overpass layers - our POIs
    var plaques = new L.OverPassLayer({
        query: "node(BBOX)['memorial'='blue_plaque'];out;",
        callback: function(data) {
            for (var i = 0; i < data.elements.length; i++) {
                var e = data.elements[i];
                if (e.id in this.instance._ids) return;
                this.instance._ids[e.id] = true;
                var pos = new L.LatLng(e.lat, e.lon);
                var popup = this.instance._poiInfo(e.tags, e.id);
                var color = e.tags.collection_times ? 'green' : 'red';
                var circle = L.circle(pos, 10, {
                    color: color,
                    fillColor: '#33F',
                    fillOpacity: 0.5
                }).bindPopup(popup);
                this.instance.addLayer(circle);
            }
        }
    });

    var shop = new L.OverPassLayer({
        query: "node(BBOX)['shop'];out;",
        callback: function(data) {
            for (var i = 0; i < data.elements.length; i++) {
                var e = data.elements[i];
                if (e.id in this.instance._ids) return;
                this.instance._ids[e.id] = true;
                var pos = new L.LatLng(e.lat, e.lon);
                var popup = this.instance._poiInfo(e.tags, e.id);
                var color = e.tags.collection_times ? 'green' : 'red';
                var circle = L.circle(pos, 10, {
                    color: color,
                    fillColor: '#F33',
                    fillOpacity: 0.5
                }).bindPopup(popup);
                this.instance.addLayer(circle);
            }
        }
    });

    var cafe = new L.OverPassLayer({
        query: "node(BBOX)['amenity'='cafe'];out;",
        callback: function(data) {
            for (var i = 0; i < data.elements.length; i++) {
                var e = data.elements[i];
                if (e.id in this.instance._ids) return;
                this.instance._ids[e.id] = true;
                var pos = new L.LatLng(e.lat, e.lon);
                var popup = this.instance._poiInfo(e.tags, e.id);
                var color = e.tags.collection_times ? 'green' : 'red';
                var circle = L.circle(pos, 10, {
                    color: color,
                    fillColor: '#3F3',
                    fillOpacity: 0.5
                }).bindPopup(popup);
                this.instance.addLayer(circle);
            }
        }
    });

    var bins = new L.OverPassLayer({
        query: "node(BBOX)['amenity'='waste_basket'];out;",
        callback: function(data) {
            for (var i = 0; i < data.elements.length; i++) {
                var e = data.elements[i];
                if (e.id in this.instance._ids) return;
                this.instance._ids[e.id] = true;
                var pos = new L.LatLng(e.lat, e.lon);
                var popup = this.instance._poiInfo(e.tags, e.id);
                var color = e.tags.collection_times ? 'green' : 'red';
                var circle = L.circle(pos, 10, {
                    color: color,
                    fillColor: '#555',
                    fillOpacity: 0.5
                }).bindPopup(popup);
                this.instance.addLayer(circle);
            }
        }
    });

    var defib = new L.OverPassLayer({
        query: "node(BBOX)['emergency'='defibrillator'];out;",
        callback: function(data) {
            for (var i = 0; i < data.elements.length; i++) {
                var e = data.elements[i];
                if (e.id in this.instance._ids) return;
                this.instance._ids[e.id] = true;
                var pos = new L.LatLng(e.lat, e.lon);
                var popup = this.instance._poiInfo(e.tags, e.id);
                var color = e.tags.collection_times ? 'green' : 'red';
                var circle = L.circle(pos, 10, {
                    color: color,
                    fillOpacity: 0.5
                }).bindPopup(popup);
                this.instance.addLayer(circle);
            }
        }
    });

    var historic = new L.OverPassLayer({
        query: "node(BBOX)['historic'~'.*'];out;",
        callback: function(data) {
            for (var i = 0; i < data.elements.length; i++) {
                var e = data.elements[i];
                if (e.id in this.instance._ids) return;
                this.instance._ids[e.id] = true;
                var pos = new L.LatLng(e.lat, e.lon);
                var popup = this.instance._poiInfo(e.tags, e.id);
                var color = e.tags.collection_times ? 'green' : 'red';
                var circle = L.circle(pos, 10, {
                    color: color,
                    fillOpacity: 0.5
                }).bindPopup(popup);
                this.instance.addLayer(circle);
            }
        }
    });

    var tourism = new L.OverPassLayer({
        query: "node(BBOX)['tourism'];out;",
        callback: function(data) {
            for (var i = 0; i < data.elements.length; i++) {
                var e = data.elements[i];
                if (e.id in this.instance._ids) return;
                this.instance._ids[e.id] = true;
                var pos = new L.LatLng(e.lat, e.lon);
                var popup = this.instance._poiInfo(e.tags, e.id);
                var color = e.tags.collection_times ? 'green' : 'red';
                var circle = L.circle(pos, 10, {
                    color: color,
                    fillColor: '#000',
                    fillOpacity: 0.5
                }).bindPopup(popup);
                this.instance.addLayer(circle);
            }
        }
    });

    var photos = new L.OverPassLayer({
        query: "node(BBOX)['tourism'='photo'];out;",
        callback: function(data) {
            for (var i = 0; i < data.elements.length; i++) {
                var e = data.elements[i];
                if (e.id in this.instance._ids) return;
                this.instance._ids[e.id] = true;
                var pos = new L.LatLng(e.lat, e.lon);
                var popup = `<img src="images/${e.id}.jpg" alt="Photo" style="width: 100%; height: auto;">`;
                var color = e.tags.collection_times ? 'green' : 'red';
                var circle = L.circle(pos, 10, {
                    color: color,
                    fillColor: '#000',
                    fillOpacity: 0.5
                }).bindPopup(popup);
                this.instance.addLayer(circle);
            }
        }
    });

    // And here we list of the aforementioned POI
    var additionalOverlayLayers = {
        "Plaques": plaques,
        "Shops": shop,
        "Cafes": cafe,
        "Bins": bins,
        "Defibrillator": defib,
        "Historic": historic,
        "Tourism": tourism,
        "Photos": photoLayer
    };

    // Add main overlay layers to the map
    for (var overlayName in mainOverlayLayers) {
        // Set layers to be hidden initially
        modernMap.addLayer(mainOverlayLayers[overlayName]);
        if (overlayName != "1747") {
          modernMap.removeLayer(mainOverlayLayers[overlayName]);
        }
    }

    // The scrollbar for our POIs
    var horizontalLayerControl2 = L.Control.extend({
        options: {
            position: 'topright'
        },
        onAdd: function (map) {
            var container = L.DomUtil.create('div', 'leaflet-control-layers-horizontal');

            for (var overlayName in additionalOverlayLayers) {
                var label = L.DomUtil.create('label', '', container);
                var input = L.DomUtil.create('input', '', label);
                input.type = 'checkbox';
                input.name = 'overlaylayer';
                input.value = overlayName;
                input.checked = map.hasLayer(additionalOverlayLayers[overlayName]);
                input.layer = additionalOverlayLayers[overlayName];
                input.onclick = function () {
                    if (map.hasLayer(this.layer)) {
                        map.removeLayer(this.layer);
                    } else {
                        map.addLayer(this.layer);
                    }
                };
                label.appendChild(document.createTextNode(overlayName));
            }

            return container;
        }
    });

  modernMap.addControl(new horizontalLayerControl2());

  // Add slider functionality for both mouse and touch events
  var sliderHandle = document.getElementById('slider-handle');
  var sliderBar = document.getElementById('slider');
  var sliderLabel = document.getElementById('slider-label');
  var sliderBarRect = sliderBar.getBoundingClientRect();
  var sliderWidth = sliderBar.offsetWidth - sliderHandle.offsetWidth;
  var numLayers = Object.keys(mainOverlayLayers).length;
  var layerNames = Object.keys(mainOverlayLayers);

  var startDate = 1747
  var endDate = 2024
  var diff = endDate-startDate;

  function handleStart(event) {
      event.preventDefault();
      var startX = (event.type === 'touchstart') ? event.touches[0].clientX : event.clientX;
      var initialLeft = sliderHandle.offsetLeft;

      function handleMove(event) {
          event.preventDefault();
          var clientX = (event.type === 'touchmove') ? event.touches[0].clientX : event.clientX;
          var newX = initialLeft + (clientX - startX);
          if (newX < 0) newX = 0;
          if (newX > sliderWidth) newX = sliderWidth;
          var percentage = newX / sliderWidth;
          var activeIndex = Math.round((numLayers - 1) * percentage);
          var activeLayerName = layerNames[activeIndex];
          var activeLayer = mainOverlayLayers[activeLayerName];

        //sliderLabel.textContent = activeLayerName;
        sliderLabel.textContent = Math.round(((endDate - startDate) * percentage) + startDate);

          for (var i = 0; i < layerNames.length; i++) {
            //var differenceBetweenYears = layerNames[i+1]-layerNames[i];
              var layerName = layerNames[i];
              var nextLayerName = layerNames[i+1];
              var layer = mainOverlayLayers[layerName];

              if (i < (layerNames.length-1)){
                if (sliderLabel.textContent >= layerName && sliderLabel.textContent < nextLayerName) {
                    modernMap.addLayer(layer);
                } else {
                    modernMap.removeLayer(layer);
                }
              }
              else {
                {
                  if (sliderLabel.textContent >= layerName) {
                      modernMap.addLayer(layer);
                  } else {
                      modernMap.removeLayer(layer);
                  }
                }
              }

          }
          sliderHandle.style.left = newX + 'px';
          sliderLabel.style.left = newX + 'px';
      }

      function handleEnd(event) {
          event.preventDefault();
          document.removeEventListener('mousemove', handleMove);
          document.removeEventListener('mouseup', handleEnd);
          document.removeEventListener('touchmove', handleMove);
          document.removeEventListener('touchend', handleEnd);
      }

      document.addEventListener('mousemove', handleMove);
      document.addEventListener('mouseup', handleEnd);
      document.addEventListener('touchmove', handleMove);
      document.addEventListener('touchend', handleEnd);
  }

  sliderHandle.addEventListener('mousedown', handleStart);
  sliderHandle.addEventListener('touchstart', handleStart);

  // Set initial position of slider handle
  var initialPosition = 0;
  sliderHandle.style.left = initialPosition + 'px';
  sliderLabel.textContent = layerNames[0]; // Set initial label text

  sliderLabel.style.left = initialPosition + 'px';

  // Update sliderBarRect on window resize
  window.addEventListener('resize', function() {
      sliderBarRect = sliderBar.getBoundingClientRect();
  });
</script>

 </body>
</html>
